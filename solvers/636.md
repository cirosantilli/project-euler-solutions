# Project Euler 636 Solution - Restricted Factorisations

<https://projecteuler.net/problem=636>:

* [636.py](636.py)

This solution computes:

\[
F(n!) = \#\left\{\text{ways to write } n! = a^1 b_1^2 b_2^2 c_1^3 c_2^3 c_3^3 d_1^4 d_2^4 d_3^4 d_4^4
\right\}
\]

subject to:

- all **base numbers** \(a,b_i,c_j,d_k\) are **pairwise distinct**
- **order is irrelevant** within identical exponent groups (2 squares, 3 cubes, 4 fourth powers)

All answers are taken modulo:

\[
10^9 + 7
\]

---

## Key Techniques Used

### 1) Prime-wise exponent distribution
If:

\[
n! = \prod_{p} p^{e_p}
\]

then distributing exponents across factors corresponds to choosing nonnegative integers \(x_i\) such that:

\[
\sum w_i x_i = e_p
\]

where \(w_i\) are the factor exponents (1,2,2,3,3,3,4,4,4,4).

For each prime \(p\), the number of valid distributions depends only on \(e_p\) and the multiset of weights.

---

### 2) Inclusion–Exclusion over equal bases
Distinct bases means **no two factors may share the same base**.

Equality constraints correspond to merging factor slots into blocks.
If a block contains slots with weights \(w_{i_1},...,w_{i_k}\), its merged weight is:

\[
W = w_{i_1} + \cdots + w_{i_k}
\]

Then for each prime we count solutions of:

\[
\sum_{blocks} W_j x_j = e_p
\]

We apply Möbius inversion (inclusion–exclusion) over all **set partitions** of 10 slots:

\[
\mu(\pi) = \prod_{B\in\pi} (-1)^{|B|-1} (|B|-1)!
\]

Partitions that share the same block-weight multiset are aggregated, reducing 115,975 partitions to only 966 distinct keys.

---

### 3) Generating function coefficient extraction
For a given key (block weight multiset) \((W_1,...,W_k)\), we need:

\[
N(e) = [x^e]\prod_{i=1}^k \frac{1}{1-x^{W_i}}
\]

- For **small exponents** (≤ 13,000), this coefficient is computed efficiently using a standard **coin-change DP** in \(O(k\cdot cutoff)\).

---

### 4) Linear recurrence for large exponents
The generating function is rational:

\[
\prod \frac{1}{1-x^{W_i}} = \frac{1}{Q(x)},\quad Q(x)=\prod (1-x^{W_i})
\]

Since all \(W_i\) sum to 30, \(Q(x)\) always has degree 30, so the coefficient sequence satisfies an order-30 recurrence.

Large coefficients (up to ~1,000,000) are evaluated using:

- polynomial exponentiation in the quotient ring defined by the recurrence
- precomputed powers of \(x^{2^b}\) to answer many large queries per key efficiently

---

### 5) Indistinguishable permutations correction
The inclusion–exclusion step counts a **labelled** arrangement of the 10 slots.

But the problem considers:

- 2 squares unordered → divide by \(2!\)
- 3 cubes unordered → divide by \(3!\)
- 4 fourth-powers unordered → divide by \(4!\)

So we multiply by modular inverse of:

\[
2!\cdot 3!\cdot 4! = 288
\]

---

## Validation
The program includes asserts from the statement:

- \(F(25!) = 4933\)
- \(F(100!) \bmod 10^9+7 = 693,952,493\)
- \(F(1000!) \bmod 10^9+7 = 6,364,496\)

---

## Final Answer
The program prints:

\[
F(1,000,000!) \bmod 10^9+7 = 888316
\]
