# Project Euler 354 Solution - Distances in a Bee's Honeycomb

<https://projecteuler.net/problem=354>:

* [354.py](354.py)

This solution uses number theory on the **hexagonal/triangular lattice** (the lattice of centres of the hex cells).

## Geometry → quadratic form

For hexagons with side length 1, neighbouring cell centres are at distance `√3`.

Using integer coordinates `(x, y)` on a triangular lattice basis, squared distances satisfy:

\[
L^2 = 3(x^2 + xy + y^2)
\]

So if we write \( n = L^2/3 \), then **cells at distance \(L\)** correspond exactly to integer solutions of

\[
x^2 + xy + y^2 = n
\]

and `B(L)` is the number of such solutions.

## Representation formula (Eisenstein integers)

The form \(x^2+xy+y^2\) is the norm form in the **Eisenstein integers** \( \mathbb{Z}[\omega] \).
A standard result gives:

\[
B(\sqrt{3n}) = 6\sum_{d\mid n}\chi(d)
\]

where \( \chi \) is the Dirichlet character mod 3:

- \( \chi(d)=1 \) if \( d\equiv 1\pmod{3} \)
- \( \chi(d)=-1 \) if \( d\equiv 2\pmod{3} \)
- \( \chi(d)=0 \) if \( 3\mid d \)

Let \(R(n)=\sum_{d\mid n}\chi(d)\). Then `B = 6*R`.

The problem asks for `B(L)=450`, so we need:

\[
R(n)=75
\]

with \( n \le \left\lfloor (5\cdot 10^{11})^2/3 \right\rfloor \).

## Multiplicativity and the prime-exponent constraints

`R(n)` is multiplicative, and for prime powers:

- \(p=3\): \(R(3^k)=1\) (3-powers do not affect `R`)
- \(p\equiv 1\pmod{3}\): \(R(p^k)=k+1\)
- \(p\equiv 2\pmod{3}\): \(R(p^k)=1\) if \(k\) even, else `0`

So:

- Any prime \( \equiv 2 \pmod{3} \) must have an **even** exponent (otherwise `R=0`).
- The entire value of `R(n)` comes from primes \( \equiv 1 \pmod{3} \):

\[
R(n)=\prod_{p\equiv 1 (3)} (e_p+1)
\]

Thus `R(n)=75` forces the “1 mod 3” part of `n` to have exponent patterns coming from factorizations of 75:

- \(75 = 25\cdot 3 \Rightarrow (e_p,e_q)=(24,2)\)
- \(75 = 15\cdot 5 \Rightarrow (14,4)\)
- \(75 = 5\cdot 5\cdot 3 \Rightarrow (4,4,2)\)

Everything else in `n` is a factor \(3^a\) and a square of primes \( \equiv 2\pmod{3} \).

## Counting the remaining freedom

For a fixed “1 mod 3” core \(A\), we need to count:

\[
n = A \cdot 3^a \cdot b^2
\]

where all prime factors of `b` are \( \equiv 2\pmod{3} \).
This becomes:

\[
\sum_{a\ge 0} \#\{ b \le \sqrt{\lfloor (N/A)/3^a \rfloor} : \text{all primes of } b \equiv 2\ (3)\}
\]

The code precomputes this counting function up to the needed maximum with a sieve and a prefix-sum array.

## Quotient grouping for the large case

The pattern `(4,4,2)` includes a prime `r` with exponent 2 that can be as large as ~35 million in the smallest base case.
Iterating over all such primes would be too slow.

Instead, for fixed \(C\) we sum over primes `r` using that:

\[
\left\lfloor \frac{C}{r^2}\right\rfloor
\]

stays constant over long ranges of `r`. We jump by ranges:

- compute `t = C // r_low^2`
- compute `r_high = floor(sqrt(C//t))`
- count how many valid primes are in `[r_low, r_high]`
- add `count * G(t)`

This reduces work to about \(O(C^{1/3})\) steps in the heaviest case.

## Result

Running `main.py` prints the required count of radii \(L \le 5\times 10^{11}\) with `B(L)=450`.

The program also includes asserts for the three example values from the problem statement.
