# Project Euler 448 Solution - Average Least Common Multiple

<https://projecteuler.net/problem=448>:

* [448.py](448.py)

## 1. Algebraic rewriting of the problem

We start from:

\[
A(n)=\frac{1}{n}\sum_{i=1}^{n} \text{lcm}(n,i)
\qquad
S(N)=\sum_{k=1}^{N} A(k)
\]

Use:

\[
\text{lcm}(n,i)=\frac{n\,i}{\gcd(n,i)}
\]

Group terms by `d = gcd(n,i)` and substitute `i = dÂ·j` with `gcd(j,n/d)=1`.
This cancels the factor `n` in the average and yields a divisor sum.

---

## 2. Reduced residue sum identity

Define:

\[
J(m)=\sum_{1\le j\le m,\ \gcd(j,m)=1} j
\]

A known number theory fact gives:

- \(J(1)=1\)
- For \(m>1\): \(J(m)=\frac{m\,\varphi(m)}{2}\)

Then:

\[
A(n)=\sum_{d\mid n} J(d)
\]

---

## 3. Swap the order of summation (Dirichlet hyperbola trick)

\[
S(N)=\sum_{n\le N}\sum_{d\mid n} J(d)
     =\sum_{d\le N} J(d)\left\lfloor\frac{N}{d}\right\rfloor
\]

Equivalently:

\[
S(N)=\sum_{k=1}^{N}\Big(\sum_{d\le N/k} J(d)\Big)
     =\sum_{k=1}^{N} \text{prefixJ}\!\left(\left\lfloor\frac{N}{k}\right\rfloor\right)
\]

The quotient \(\left\lfloor N/k\right\rfloor\) takes only about \(2\sqrt{N}\) distinct values,
so we compute the sum in blocks.

---

## 4. Summatory function needed

Since \(J(d)=\frac{d\varphi(d)}{2}\) for \(d>1\), define:

\[
F(n)=\sum_{k\le n} k\varphi(k)
\]

Then:

\[
\text{prefixJ}(n)=\sum_{k\le n} J(k)=\frac{F(n)+1}{2}
\]

So the goal becomes fast evaluation of \(F(n)\) for large `n`.

---

## 5. Du Jiao sieve (floor-division recursion)

We exploit the convolution identity:

\[
(k\varphi(k)) * \text{id} = \text{id}^2
\]

This implies a summatory recursion:

\[
F(n)=\sum_{i=1}^{n} i^2 - \sum_{i=2}^{n}\left(\sum_{k=i}^{j}k\right)F\!\left(\left\lfloor\frac{n}{i}\right\rfloor\right)
\]

where `j` is the maximum index such that `n//i` remains constant.

The recursion runs in about \(O(\sqrt{n})\) steps per distinct value and,
with memoization and a precomputed sieve for small values, is practical for \(n\approx 10^{11}\).

---

## 6. Final computation

1. Sieve `phi` up to a chosen limit.
2. Precompute prefix `F(x)=sum_{k<=x} k*phi(k)` for small `x`.
3. Use Du Jiao recursion for larger `x`.
4. Compute:

\[
S(N)=\sum_{k=1}^{N}\text{prefixJ}(N//k)
\]

in quotient blocks, all modulo `999999017`.

---

## Complexity

- Sieve: \(O(L)\) time, \(O(L)\) memory
- Recursion: ~\(O(N^{2/3})\) practical behavior with memoization
- Outer summation: \(O(\sqrt{N})\) blocks

All operations are integer-only; no external libraries are used.
