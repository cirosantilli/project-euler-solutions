# Project Euler 337 Solution - Totient Stairstep Sequences

<https://projecteuler.net/problem=337>:

* [337.py](337.py)

`main.py` computes the number of sequences `{a1, a2, ..., an}` with

- `a1 = 6`
- `φ(ai) < φ(ai+1) < ai < ai+1`

and outputs `S(20_000_000) mod 10^8`.

The file also contains `assert` tests for the values given in the problem statement.

## Main techniques

### 1) Dynamic programming over the last element

Let `f(x)` be the number of valid sequences that **end** at `x`.

- Base case: `f(6) = 1` (the sequence `{6}`)
- For `x != 6`, we need to sum over all possible previous terms `a`:

`a < x` and `φ(a) < φ(x) < a`

so

`f(x) = Σ f(a)` over all `a < x` with `φ(a) < φ(x) < a`.

Finally,

`S(N) = Σ_{x<=N} f(x)`.

### 2) Turn the transition into “interval contributions” on totient values

Fix a previous term `a`. For a future term `x` to follow `a`, we need

`φ(a) < φ(x) < a`.

If we denote `t = φ(x)`, then **`a` contributes to every future node whose totient value `t` lies in the interval**

`φ(a) + 1 <= t <= a - 1`.

When we process candidates `x` in increasing order, the condition `a < x` is automatically satisfied, so:

- `f(x)` becomes: “current total contribution at `t = φ(x)`”,
- then `f(x)` is added as a new contributor over `[φ(x)+1, x-1]`.

This converts the DP into:

- **point query** at `t = φ(x)`
- **range add** on `[φ(x)+1, x-1]`.

### 3) Fenwick tree on a difference array (range add + point query)

A Fenwick tree (Binary Indexed Tree) can support range-add / point-query by storing a *difference array*:

- To add `v` to every `t in [L, R]`, we do two point updates:
  - `diff[L] += v`
  - `diff[R+1] -= v`
- The value at a point `t` is then the prefix sum `Σ diff[1..t]`.

In this problem, `R = x-1`, so `R+1 = x`, meaning each step adds:

- `+f(x)` at `φ(x)+1`
- `-f(x)` at `x`.

All operations are done modulo `10^8` for the final run.

### 4) Fast totients with a linear sieve

We need `φ(k)` for all `k <= N`. `main.py` uses a **linear (Euler) sieve** which computes the totient array in `O(N)` time.

## Complexity (for the target run)

- Totient sieve: `O(N)`
- DP with Fenwick: `O(N log N)` time, `O(N)` memory
- Memory is dominated by two `array('I')` buffers (`φ` and the Fenwick tree).
