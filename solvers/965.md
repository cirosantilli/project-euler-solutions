# Project Euler 965 Solution - Expected Minimal Fractional Value

<https://projecteuler.net/problem=965>:

* [965.py](965.py)

## Core observation

For each `N`, we look at

- `f_N(x) = min({n x})` over integers `1 ≤ n ≤ N`, where `{·}` is the fractional part
- `F(N)` = the average (expected value) of `f_N(x)` for `x` uniformly distributed on `[0, 1]`

As `x` increases from `0` to `1`, the integer `n` that attains the minimum changes only at specific breakpoints.
Those breakpoints are exactly the reduced fractions with denominator ≤ `N`, i.e. the **Farey sequence** of order `N`.

Between two adjacent Farey fractions `a/b < c/d`, the same `n` stays optimal throughout that interval, and the
integral over the interval can be simplified to a very small closed form.

## Interval contribution

For two adjacent Farey fractions `a/b < c/d`:

- The width of the interval is `c/d - a/b`
- The area under the corresponding linear segment of `f_N(x)` over that interval simplifies to:

\[
\text{contribution} = \frac{1}{2 \, b \, d^2}.
\]

Therefore:

\[
F(N) = \sum_{\text{adjacent } a/b < c/d \text{ in } \mathcal{F}_N} \frac{1}{2 \, b \, d^2}.
\]

This turns the problem into a single sum over consecutive Farey terms.

## Generating the Farey sequence without sorting

Instead of enumerating fractions and sorting them, we generate consecutive Farey terms in-order using the classic
“next term” recurrence. Maintaining two adjacent fractions `a/b < c/d`, the next term after `c/d` is:

- `k = floor((N + b) / d)`
- next fraction = `(k c - a) / (k d - b)`

This produces the entire Farey sequence of order `N` in a single pass, using only integer arithmetic.

## Numerical summation

The number of adjacent pairs in the Farey sequence of order `10^4` is on the order of tens of millions.
All summands are positive and small, so double precision is sufficient, but we still reduce floating error by:

- accumulating in *chunks* (to reduce overhead),
- combining chunks using a compensated (Kahan-style) addition.

## Complexity

- Time: `O(|F_N|)` where `|F_N|` is the length of the Farey sequence (≈ proportional to `N^2`).
- Memory: `O(1)` (streaming computation; no fraction list stored).
