# Project Euler 385 Solution - Ellipses Inside Triangles

<https://projecteuler.net/problem=385>:

* [385.py](385.py)

This solution uses two key facts about triangles and their maximum-area inscribed ellipse, and then reduces the integer geometry problem to a small number of Pell-type recurrences.

## 1) Geometry → algebraic constraints

For any (non-degenerate) triangle, the unique ellipse of **maximum area** contained in it is the **Steiner inellipse** (tangent at the side midpoints). Two properties we use:

- The Steiner inellipse is **centered at the triangle’s centroid**.
- It is affine-invariant: if you apply a linear map to the triangle, the Steiner inellipse is the image of the equilateral triangle’s incircle.

Because the foci are fixed at **(±√13, 0)**, the ellipse is centered at the origin, so the triangle’s centroid must be at the origin:

\[
(x_1,y_1)+(x_2,y_2)+(x_3,y_3)=(0,0).
\]

Write the 2×2 “second-moment” matrix

\[
S=\sum_{i=1}^3
\begin{pmatrix}
x_i\\y_i
\end{pmatrix}
\begin{pmatrix}
x_i&y_i
\end{pmatrix}
=
\begin{pmatrix}
\sum x_i^2 & \sum x_i y_i\\
\sum x_i y_i & \sum y_i^2
\end{pmatrix}.
\]

For a centroid-at-origin triangle, the Steiner inellipse has semi-axis squares

\[
a^2=\frac{S_{xx}}{6},\qquad b^2=\frac{S_{yy}}{6},
\]

in the coordinate system where the ellipse is axis-aligned. Since the foci lie on the *x*-axis, the ellipse is axis-aligned in the original coordinates, so we must have

- **No cross term**: \(\sum x_i y_i = 0\).
- Fixed focal distance \(c^2=a^2-b^2=13\), hence
  \[
  \frac{S_{xx}-S_{yy}}{6}=13 \;\Longrightarrow\; \sum x_i^2-\sum y_i^2 = 78.
  \]

So we need integer triangles (inside the box \(|x|,|y|\le N\)) satisfying:

- \(x_1+x_2+x_3=0\), \(y_1+y_2+y_3=0\)
- \(\sum x_i y_i = 0\)
- \(\sum x_i^2-\sum y_i^2 = 78\)

and then sum their areas.

## 2) Complex encoding and a crucial substitution

Let \(z_i = x_i + i y_i\) (Gaussian integers). Then:

- \(\sum x_i^2-\sum y_i^2 = \Re\left(\sum z_i^2\right)\)
- \(\sum x_i y_i = \frac12 \Im\left(\sum z_i^2\right)\)

So the last two constraints compactly become:

\[
z_1^2+z_2^2+z_3^2 = 78 \quad (\text{a real Gaussian integer}).
\]

Using the centroid constraint \(z_3=-(z_1+z_2)\), this reduces to

\[
z_1^2+z_1 z_2+z_2^2 = 39.
\]

Now set

\[
p = z_1 - z_2,\qquad q = z_1 + z_2 \quad (\text{so } z_3=-q).
\]

A direct expansion gives the simplification

\[
z_1^2+z_1 z_2+z_2^2 = \frac{p^2 + 3q^2}{4},
\]

so the problem becomes the single Gaussian equation

\[
p^2 + 3 q^2 = 156.
\]

Writing \(p=a+bi\), \(q=c+di\) yields two integer equations (real and imaginary parts):

- \(ab + 3cd = 0\)
- \((a^2-b^2) + 3(c^2-d^2) = 156\)

## 3) Orthogonality → factorization → Pell equations

The imaginary condition is a dot product:

\[
(a,3c)\cdot(b,d)=0.
\]

Thus \((a,3c)\) and \((b,d)\) are orthogonal integer vectors, so we can write

- \((a,3c)=s(m,n)\) with \(\gcd(m,n)=1\)
- \((b,d)=t(-n,m)\)

Substituting into the real equation collapses beautifully to

\[
(n^2+3m^2)\,(s^2-3t^2)=468.
\]

Let

\[
D = n^2 + 3m^2,\qquad K = 468/D.
\]

Then \(D\mid 468\) and we must solve the Pell-type equation

\[
s^2 - 3t^2 = K.
\]

Only a few \((D,K)\) are actually solvable here, and each solvable \(K\) has only a small number of orbits. All positive solutions in an orbit are generated by the fundamental unit of \(\mathbb{Z}[\sqrt{3}]\):

\[
(s+t\sqrt{3}) \mapsto (s+t\sqrt{3})(2+\sqrt{3}),
\]

which in integers is the recurrence

\[
(s',t') = (2s+3t,\; s+2t).
\]

Because \(s,t\) grow exponentially, only \(O(\log N)\) terms are within the box.

## 4) Reconstructing vertices and area in O(1)

From \(p,q\):

\[
z_1=\frac{p+q}{2},\quad z_2=\frac{q-p}{2},\quad z_3=-q,
\]

with a parity check to keep coordinates integral.

The area simplifies to an integer “quarters” formula:

\[
\text{Area} = \frac{D\,|s\,t|}{4}.
\]

The program generates all valid triangles inside \(|x|,|y|\le N\), deduplicates them by sorted vertex triples, and sums their areas exactly with integer arithmetic.

## 5) Complexity

- Enumerating all possible primitive \((m,n)\) is constant work (tiny bounds).
- For each Pell orbit, the recurrence runs for \(O(\log N)\) steps.
- For \(N=10^9\) this yields only a few hundred candidates.

So the whole solution runs essentially instantly in pure Python.
