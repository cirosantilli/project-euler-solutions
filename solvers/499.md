# Project Euler 499 Solution - St. Petersburg Lottery

<https://projecteuler.net/problem=499>:

* [499.py](499.py)

This solution models the gambler’s fortune **after each game** as a Markov chain / random walk.

## 1) Random-walk formulation

In one game the pot ends at `2^k` where `k ≥ 0` is the number of heads before the first tail, so

- `P(k) = 1 / 2^(k+1)`
- fortune update: `S_{n+1} = S_n - m + 2^k`

The player is **ruined** when `S_n < m` (can’t pay the next entry fee).

Let `p_m(s)` be the probability of **never** being ruined.

## 2) Exponential martingale / “adjustment coefficient”

Consider an exponential test function `exp(t S_n)`.  
If we choose `t` so that

\[
\mathbb{E}\left[e^{t(S_{n+1}-S_n)}\right] = 1,
\]

then `exp(t S_n)` is a martingale while the game continues.

Here `S_{n+1}-S_n = -m + 2^k`, so the condition becomes:

\[
e^{m t} = \sum_{k\ge 0} \frac{e^{2^k t}}{2^{k+1}}.
\]

Besides the trivial root `t=0`, this equation has a unique root with `t<0`.
With that root, one can show (via optional stopping / boundary conditions for this
particular walk) that for `s ≥ m`:

\[
p_m(s) = 1 - e^{t (s-m+1)}.
\]

(And `p_m(s)=0` for `s<m`.)

So the whole problem reduces to **finding `t`** for `m=15`.

## 3) Numerics: robust root finding + fast series truncation

### Stable function evaluation
Directly evaluating `exp(m t) - Σ exp(2^k t)/2^(k+1)` loses precision near `t≈0`
because both sides are close to `1`.

We use the identity `Σ 1/2^(k+1) = 1` and rewrite:

\[
f(t) = \operatorname{expm1}(m t) - \sum_{k\ge 0} \frac{\operatorname{expm1}(2^k t)}{2^{k+1}}.
\]

This avoids catastrophic cancellation.

### Truncating the infinite sum
For `t<0`, the term `exp(2^k t)` decays **super-exponentially** in `k`,
and the weights `1/2^(k+1)` also decay exponentially. So only a few dozen terms
matter in double precision.

### Bisection
The negative root is bracketed by expanding an interval away from `0`
until `f(t)` changes sign, then refined with bisection (deterministic and stable).

## 4) Output
Finally we compute `p_15(10^9)` and print it rounded to 7 decimals, as required.
