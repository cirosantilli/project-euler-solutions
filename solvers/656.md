# Project Euler 656 Solution - Palindromic Sequences

<https://projecteuler.net/problem=656>:

* [656.py](656.py)

This solution avoids simulating the sequence \(S_\alpha(n)\) directly.
Instead, it uses a structural fact about *palindromic prefixes* of the word induced by an irrational slope.

## Main techniques

### 1) Beatty-difference word \(\rightarrow\) Sturmian word
For \(\alpha=\sqrt{\beta}\) (irrational), define

\[
S_\alpha(n)=\lfloor \alpha n\rfloor-\lfloor \alpha(n-1)\rfloor.
\]

Write \(\alpha = a_0 + \theta\) where \(a_0=\lfloor \alpha\rfloor\) and \(0<\theta<1\). Then

\[
S_\alpha(n)=a_0 + \big(\lfloor \theta n\rfloor-\lfloor \theta(n-1)\rfloor\big),
\]

so the variable part is a binary 0/1 “step” sequence. This is the **characteristic Sturmian word**
(mechanical word) of slope \(\theta\). Palindromic prefixes are preserved under the fixed
letter-mapping \(0\mapsto a_0\), \(1\mapsto a_0+1\).

### 2) Continued fractions give all palindromic prefix lengths
Let the continued fraction of \(\theta\) be

\[
\theta = [0; a_1,a_2,a_3,\dots].
\]

Define denominators \(q_k\) of convergents by:

- \(q_{-1}=0,\; q_0=1\)
- \(q_k = a_k q_{k-1} + q_{k-2}\) for \(k\ge 1\)

A known property of characteristic Sturmian words is that the lengths \(n\) where the prefix is palindromic
are exactly

\[
n = q_{k-2} + t\,q_{k-1}\quad\text{for odd }k,\; 1\le t\le a_k,
\]

listed in increasing order (these are denominators of **intermediate convergents** at odd indices).

The code asserts the statement’s example for \(\sqrt{31}\): the first 20 lengths and their sum
\(H_{20}(\sqrt{31})=150243655\).

### 3) O(1) summation per block
For a fixed odd \(k\), the \(a_k\) produced lengths form an arithmetic progression:

\[
q_{k-2}+q_{k-1},\; q_{k-2}+2q_{k-1},\;\dots,\; q_{k-2}+a_k q_{k-1}.
\]

So the sum of the first \(t_{\max}\) terms is:

\[
t_{\max}q_{k-2} + q_{k-1}\frac{t_{\max}(t_{\max}+1)}{2}.
\]

This lets us compute \(H_{100}\) quickly without listing all 100 values. Since only the last 15 digits
are needed, all accumulation is done modulo \(10^{15}\).

### 4) Continued fraction period of \(\sqrt{\beta}\) with integers
For non-square \(\beta\), \(\sqrt{\beta}\) has a periodic continued fraction

\[
\sqrt{\beta} = [a_0; \overline{a_1,a_2,\dots,a_L}].
\]

The standard integer recurrence generates the period:

- \(m_0=0,\; d_0=1,\; a_0=\lfloor\sqrt{\beta}\rfloor\)
- \(m_{i+1}=d_i a_i-m_i\)
- \(d_{i+1}=(\beta-m_{i+1}^2)/d_i\)
- \(a_{i+1}=(a_0+m_{i+1})/d_{i+1}\)

The period ends when \(a_{i+1}=2a_0\).

Because \(\theta=\sqrt{\beta}-a_0=[0;a_1,a_2,\dots]\), the same periodic tail \(a_1,a_2,\dots\)
is exactly what we need.

## Output
`main.py` prints the last 15 digits of

\[
\sum_{\beta\in T} H_{100}(\sqrt{\beta})
\]

where \(T\) is \(\{2,3,5,6,\dots,1000\}\) excluding perfect squares.
