# Project Euler 903 Solution - Total Permutation Powers

<https://projecteuler.net/problem=903>:

* [903.py](903.py)

We need

\[
Q(n)=\sum_{\pi\in S_n}\ \sum_{i=1}^{n!}\operatorname{rank}(\pi^i)
\quad (\bmod\ 10^9+7),
\]

where `rank` is the 1-based lexicographic position of a permutation written in one-line notation.

---

## 1) Turn the double sum into an expectation

Choose uniformly:

- a permutation `π ∈ S_n`,
- an exponent `i ∈ {1,…,n!}`.

Because every permutation order divides `n!`, `π^i` is uniformly distributed over the cyclic subgroup generated by `π`.

So

\[
Q(n)=n!^2\ \mathbb{E}[\operatorname{rank}(\sigma)]
\]

where \(\sigma = \pi^i\) under the above sampling.

---

## 2) Express lexicographic rank via Lehmer/inversion digits

The lexicographic rank can be written using inversion-table digits:

\[
\operatorname{rank}(\sigma)=1+\sum_{k=1}^{n-1} (n-k)!\,L_k
\]

where

\[
L_k = \#\{j>k:\sigma(j)<\sigma(k)\}.
\]

By linearity of expectation,

\[
\mathbb{E}[L_k]=\sum_{j>k}\Pr(\sigma(j)<\sigma(k)).
\]

---

## 3) Key symmetry: pair inversion probability depends only on distance

For the distribution of a random power of a random permutation, one can show:

\[
\Pr(\sigma(k+d)<\sigma(k)) = P_d,
\]

i.e. it depends only on the distance `d`, not on the position `k`.

Even better: `P_d` is **linear in d**, so every \(\mathbb{E}[L_k]\) becomes a simple arithmetic-series sum.

That collapses the full rank expectation into only two factorial-weighted sums:

- \(\sum m!\,m\)
- \(\sum m!\,\frac{m(m+1)}{2}\)

---

## 4) Reduce everything to two probabilities (α and β)

The constants in the linear form of `P_d` depend only on:

- **α**: probability that two chosen elements are *both fixed* by σ  
  \(\alpha = \Pr(\sigma(x)=x,\ \sigma(y)=y)\)

- **β**: probability that two chosen elements are *swapped* by σ  
  \(\beta = \Pr(\sigma(x)=y,\ \sigma(y)=x)\)

### β (swap probability)

A swap occurs only if the two elements lie opposite in an even-length cycle and the exponent selects the half-rotation. This yields a clean harmonic expression:

\[
\beta = \frac{H_{\lfloor n/2\rfloor}}{2n(n-1)}.
\]

### α (double fixed-point probability)

Condition on the cycle lengths `L1, L2` of the two selected elements in the original random permutation.

Both are fixed iff the exponent is divisible by `lcm(L1,L2)`, so

\[
\alpha = \mathbb{E}\left[\frac{1}{\mathrm{lcm}(L_1,L_2)}\right]
= \mathbb{E}\left[\frac{\gcd(L_1,L_2)}{L_1 L_2}\right].
\]

This becomes a weighted gcd-sum over a triangular region.

---

## 5) Möbius inversion + harmonic numbers to compute α in O(n log n)

The key transform uses:

- \(\gcd(a,b)\) via divisor decomposition,
- Möbius inversion to isolate coprimality,
- harmonic numbers \(H_k=\sum_{i=1}^k 1/i\) computed modulo `MOD`.

A divisor-sum convolution over multiples computes the needed structure in:

- **Time:** \(O(n \log n)\)
- **Memory:** \(O(n)\)

All rational quantities are handled modulo `10^9+7` using modular inverses.

---

## 6) Final assembly

Once α and β are known, `P_d` is a linear function, so:

- compute two factorial-weighted sums in one pass,
- combine into \(\mathbb{E}[\operatorname{rank}(\sigma)]\),
- multiply by \(n!^2\) modulo `MOD`.

---

## 7) Validation

The implementation asserts the statement’s sample values:

- `Q(2) = 5`
- `Q(3) = 88`
- `Q(6) = 133103808`
- `Q(10) ≡ 468421536 (mod 1e9+7)`

Then prints `Q(10^6) mod 1e9+7`.

(Per instructions, the final numeric answer is not embedded or asserted.)
