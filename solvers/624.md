# Project Euler 624 Solution - Two Heads Are Better Than One

<https://projecteuler.net/problem=624>:

* [624.py](624.py)

We repeatedly toss an unbiased coin until the first time we see **two consecutive heads** (`HH`).
Let `M` be the index of the second `H` in that first `HH`.
Define `P(n) = Pr(n | M)`.

The task is to compute:

- `Q(P(10^18), 1_000_000_009)`

where for a reduced fraction `a/b` and prime `p`, `Q(a/b, p)` is the smallest positive `q` such that:

- `a ≡ b·q (mod p)`

This is just modular division: `q ≡ a·b⁻¹ (mod p)` (mapped to `1..p`).

---

## 1) Counting sequences: Fibonacci appears

`M = m` means:

- the tosses end in `... T H H` (or just `HH` when `m = 2`)
- there is **no** earlier `HH`

So the first `m-3` tosses form a binary string with **no consecutive heads**.
The number of length-`L` binary strings with no consecutive `1`s is `F_{L+2}`.

Therefore, for `m ≥ 2`:

\[
\Pr(M=m) = \frac{F_{m-1}}{2^m}.
\]

So:

\[
P(n)=\sum_{k\ge 1}\Pr(M=nk)=\sum_{k\ge 1}\frac{F_{nk-1}}{2^{nk}}.
\]

---

## 2) Matrix form for Fibonacci

Use the Fibonacci Q-matrix:

\[
A=\begin{pmatrix}1&1\\1&0\end{pmatrix},\qquad
A^t\binom{1}{0}=\binom{F_{t+1}}{F_t}.
\]

Let `B = A^n`. With a small index shift, `F_{nk-1}` becomes a fixed linear form of `B^k`.

That turns the infinite sum into a **matrix geometric series**.

---

## 3) Matrix geometric series in a finite field

Let `s = 2^{-n} (mod p)` and define `M = s·B (mod p)`.

Then:

\[
\sum_{k\ge 1} (sB)^k = M(I-M)^{-1}
\]

(as long as `(I-M)` is invertible modulo `p`, which it is for this instance).

`P(n) (mod p)` is a single component of:

- `M(I-M)^{-1}·v` for a fixed vector `v`

All operations are on **2×2 matrices**, so inversion is constant-time using the closed form for a 2×2 inverse.

---

## 4) Efficiency

- `A^n (mod p)` via fast exponentiation: **O(log n)** multiplications of 2×2 matrices.
- Everything else is constant time.

This easily handles `n = 10^18`.

---

## Files

- `main.py` implements the above method, includes problem-statement asserts, and prints the answer.
