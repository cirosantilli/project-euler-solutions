# Project Euler 372 Solution - Pencils of Rays

<https://projecteuler.net/problem=372>:

* [372.py](372.py)

This repository contains a fast, **exact-integer** solution for Project Euler 372.

## Key idea: convert the “odd floor” test into band counting

We want the number of integer pairs `(x, y)` in the square:

- `M < x ≤ N`
- `M < y ≤ N`

such that `floor((y/x)²)` is **odd**.

Let `n = floor((y/x)²)`. The condition “`n` is odd” means:

- `n x² ≤ y² < (n+1) x²` for some odd `n`.

Define an auxiliary counting function:

`P(k) = #{(x,y) in [L,U]² : y² < k x²}` where `L = M+1`, `U = N`.

Then the count of points in the band for a given odd `n` is exactly:

`#{n x² ≤ y² < (n+1)x²} = P(n+1) − P(n)`

So the answer is:

`R(M,N) = Σ_{odd n} ( P(n+1) − P(n) )`

For the target input, `U/L < 500`, so `n` only runs up to about `250000`, making this sum feasible.

## Computing `P(k)` efficiently

For fixed `k`, the inequality `y² < k x²` is equivalent to:

`y ≤ y_max(x)` where:

- if `k` is **not** a perfect square: `y_max(x) = floor( sqrt(k) * x )`
- if `k = s²` is a square: strictness matters and `y_max(x) = s*x − 1`

Within the square `x,y ∈ [L,U]`, for each `x` we add:

`count_y(x) = clamp(y_max(x), L..U) − L + 1` (or zero if `y_max(x) < L`)

Most `x` are “saturated” (i.e., `y_max(x) ≥ U`), contributing the full side length `U−L+1`.
Only a prefix `x ≤ b` needs the nontrivial sum.

This reduces `P(k)` to:

- a saturated rectangle area term, plus
- a sum of `floor(sqrt(k)*x)` over a contiguous `x` range.

## Fast summation of `Σ floor(i·α)` for quadratic irrationals

The hard subproblem is computing:

`S(α, n) = Σ_{i=1..n} floor(i·α)` exactly, where `α = sqrt(k)` (irrational).

This is done using **Beatty sequence reciprocity** (a lattice-point symmetry):

1. Split off the integer part: `α = q + r`, `q = floor(α)`, `0 ≤ r < 1`
   - `S(α,n) = q·n(n+1)/2 + S(r,n)`

2. For `0 < r < 1` (irrational), let `m = floor(n·r)`:
   - `S(r,n) = n·m − S(1/r, m)`

Each step reduces the problem size from `n` to `m = floor(n·r)`.
For quadratic irrationals, the process is fast (continued-fraction-like) and uses only integer arithmetic.

### Exact floors without floating point

All quantities are kept as **quadratic surds**:

`(a + b·sqrt(k)) / c`

Floors such as `floor((a + b·sqrt(k))/c)` are computed exactly via integer comparisons using
`isqrt(b²·k)` and a single correction step—no floating point is used.

## What’s in `main.py`

- An exact quadratic-surd floor routine.
- An iterative Beatty-reciprocity summation for `Σ floor(i·sqrt(k))`.
- `P(k)` computed from saturated + unsaturated parts.
- `R(M,N)` as the sum over odd bands `P(n+1)−P(n)`.
- Asserts for the two test values given in the statement.

Running `main.py` prints the answer for `R(2·10^6, 10^9)`.
