# Project Euler 699 Solution - Triffle Numbers

<https://projecteuler.net/problem=699>:

* [699.py](699.py)

We want the sum `T(N)` of all `n ≤ N` such that the reduced fraction:

\[
\frac{\sigma(n)}{n} = \frac{a}{b}
\]

has a denominator `b` equal to a positive power of 3.

## Core observations

- The divisor-sum function `σ` is **multiplicative**: if `gcd(x, y) = 1` then `σ(xy) = σ(x)σ(y)`.
- For a prime power, `σ(p^e) = 1 + p + … + p^e`.
- When we multiply a number by a *new* prime power `p^e` (with `p` not already dividing the number), the ratio updates as:

  \[
  \frac{\sigma(np^e)}{np^e} = \frac{\sigma(n)}{n} \cdot \frac{\sigma(p^e)}{p^e}
  \]

  and `p` **never divides** `σ(p^e)`.

That last point implies a very strong rule for a DFS:

> If we introduce a new prime `p`, the new denominator gains a factor `p^e`.  
> Since `σ(p^e)` cannot cancel any `p`, the only way to avoid introducing a new prime into the reduced denominator is that the *current numerator* already contains `p^e`.

So in the search we only try primes that already divide the current numerator.

## Keeping denominators small

If we start from numbers of the form:

\[
n = 2^a 3^b 5^c
\]

then after reducing `σ(n)/n`, the denominator is a divisor of `n`, so it can only contain primes from `{2,3,5}`.

Under the DFS rule above (only adding primes already present in the numerator), the denominator:

- never gains any new primes, and
- can only **shrink** when new numerator factors share gcd with it.

Therefore the denominator always stays inside `{2,3,5}` and decreases monotonically, which keeps the search space small enough for `N = 10^14`.

## Search outline

1. Enumerate all seeds `2^a 3^b 5^c ≤ N` with `b ≥ 1`.
2. For each seed, compute the reduced fraction `σ(n)/n = num/den`.
3. Depth-first search:
   - Count `n` if `den` is exactly `3^k` with `k > 0`.
   - Factor `num`, and for each prime `p > 5` dividing `num`, try multiplying by `p^e` where `p^e` is still a divisor of `num` and `n·p^e ≤ N`.
   - Update `(num, den)` and reduce by `gcd(num, den)`.

A visited set keyed by `n` prevents duplicates from different seed paths.

## Fast factorization

To factor numerators efficiently (they are not bounded by small primes), the solution uses:

- deterministic Miller–Rabin primality testing for 64-bit integers, and
- Pollard’s Rho to split composites.

Both are implemented directly in `main.py` without external packages.
