# Project Euler 421 Solution - Prime Factors of $n^{15}+1$

<https://projecteuler.net/problem=421>:

* [421.py](421.py)

We want

\[
\sum_{n=1}^{10^{11}} s(n,10^8),
\]

where \(s(n,m)\) is the sum of **distinct** prime factors of \(n^{15}+1\) that are \(\le m\).

## 1) Swap the order of summation

Because we only count **distinct** prime factors, we can rewrite:

\[
\sum_{n\le L} s(n,M)
= \sum_{p\le M} p \cdot \#\{n\le L : p \mid (n^{15}+1)\}.
\]

So we iterate over primes \(p \le 10^8\) and count how often each prime divides \(n^{15}+1\) for \(1\le n\le 10^{11}\).

## 2) Reduce to counting modular roots + use periodicity

For a fixed prime \(p\), the condition \(p \mid (n^{15}+1)\) is:

\[
n^{15} \equiv -1 \pmod p.
\]

Solutions are periodic modulo \(p\). If \(L = qp + t\) (with \(0\le t < p\)), then:

- every solution residue class contributes exactly \(q\) values of \(n\) in \([1,L]\),
- plus **one extra** if the residue is \(\le t\).

So the counting problem becomes: *find the solution residues modulo \(p\)*.

## 3) Use group structure: 15th roots of unity

For odd primes \(p\), \((\mathbb{Z}/p\mathbb{Z})^\times\) is cyclic of size \(p-1\).

Notice that \(-1\) is always a solution of \(x^{15}\equiv -1 \pmod p\).  
If \(u^{15}\equiv 1\), then \(( -u )^{15} \equiv -1\). Therefore **all** solutions are:

\[
n \equiv -u \pmod p \quad \text{where } u^{15}\equiv 1 \pmod p.
\]

The set \(\{u : u^{15}\equiv 1\}\) is a subgroup whose size is:

\[
d = \gcd(15, p-1) \in \{1,3,5,15\}.
\]

For primes \(\ge 7\), this depends only on \(p \bmod 30\):

- \(p \equiv 1 \pmod{30}\)  \(\Rightarrow d=15\)
- \(p \equiv 11 \pmod{30}\) \(\Rightarrow d=5\)
- \(p \equiv 7,13,19 \pmod{30}\) \(\Rightarrow d=3\)
- \(p \equiv 17,23,29 \pmod{30}\) \(\Rightarrow d=1\)

## 4) Generate the subgroup efficiently (no primitive root needed)

When \(d>1\), we need an element of exact order \(d\) inside that subgroup. We use:

\[
g = a^{(p-1)/d} \pmod p
\]

for small bases \(a\). This always lands in the subgroup, and we then test whether
\(g\) has **exact** order \(d\):

- for \(d=3\) or \(d=5\): \(g \ne 1\) is enough (since 3 and 5 are prime),
- for \(d=15\): we require \(g\ne 1\), \(g^3 \ne 1\), and \(g^5 \ne 1\),
  which rules out the only proper divisors \(1,3,5\).

A curated list of small bases is tried first; if (rarely) none work, the code
falls back to a short deterministic scan of \(a=2,3,4,\dots\) until it finds one.

Once we have such a generator \(g\), the subgroup elements are:

\[
1, g, g^2, \dots, g^{d-1}.
\]

Each gives a solution residue \(n \equiv -u \pmod p\).

## 5) Prime generation

Primes up to \(10^8\) are generated using an **odd-only sieve of Eratosthenes**
in a `bytearray` (about 50 MB). This avoids external libraries while keeping
memory reasonable.

## Built-in checks

The code includes asserts for the example values given in the problem statement:

- \(s(2,10)=3\)
- \(s(2,1000)=345\)
- \(s(10,100)=31\)
- \(s(10,1000)=483\)
