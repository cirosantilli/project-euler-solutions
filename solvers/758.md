# Project Euler 758 Solution - Buckets of Water

<https://projecteuler.net/problem=758>:

* [758.py](758.py)

This repository contains a no-external-libraries solution for **Project Euler 758**.

## Key idea 1: a continued-fraction formula for `P(a, b)`

For coprime integers `a â‰¤ b`, consider the regular continued fraction of the rational number `b/a`:

\[
\frac{b}{a} = [a_0; a_1, a_2, \dots, a_k]
\]

Let \(\frac{p_i}{q_i}\) be the convergents of this continued fraction.
Then the minimal number of pourings needed to measure **exactly 1 litre** satisfies:

\[
P(a,b) = 2\,(p_{k-1} + q_{k-1}) - 2
\]

That is, **`P(a,b)` depends only on the penultimate convergent** of `b/a`.

Because the final answer is required modulo \(10^9+7\), we only compute these convergents **modulo** the prime.

---

## Key idea 2: Euclid on Mersenne numbers reduces to Euclid on exponents

In the main sum we need:

\[
P\bigl(2^{p^5}-1,\;2^{q^5}-1\bigr)
\]

The numbers \(2^n - 1\) are **Mersenne-like**, and they have a crucial division identity.
Write \(E = mF + r\) with \(0 \le r < F\). Then:

\[
2^E - 1 = Q\,(2^F - 1) + (2^r - 1)
\]

where the quotient is an **integer geometric sum**:

\[
Q = \sum_{j=0}^{m-1} 2^{r + jF}
\]

So one Euclidean step on the huge integers
\((2^E-1,\,2^F-1)\) becomes a Euclidean step on the much smaller pair \((E,\,F)\),
while the continued-fraction term is exactly that geometric-sum quotient `Q`.

This means the continued fraction of:

\[
\frac{2^{q^5}-1}{2^{p^5}-1}
\]

can be generated without ever constructing the astronomical integers.

---

## Key idea 3: compute each quotient modulo \(10^9+7\)

We only need each continued-fraction term \(Q\) modulo `MOD = 1_000_000_007`.

Let:

- `ratio = 2^F (mod MOD)`
- `shift = 2^r (mod MOD)`

Then:

\[
Q \equiv 2^r \cdot \sum_{j=0}^{m-1} (2^F)^j \pmod{MOD}
\]

The inner sum is a geometric series:

- If `ratio == 1`, the sum is simply `m`.
- Otherwise:
  \[
  \sum_{j=0}^{m-1} ratio^j = \frac{ratio^m - 1}{ratio - 1} \pmod{MOD}
  \]
  using modular inverses (valid because `MOD` is prime).

---

## Putting it together

1. Generate primes `< 1000` (simple sieve).
2. For each pair `p < q`:
   - set `ea = p^5`, `eb = q^5`
   - generate continued-fraction terms for \((2^{eb}-1)/(2^{ea}-1)\) using exponent-Euclid
   - compute the **penultimate convergent** modulo `MOD`
   - convert it to `P(...) mod MOD` using `2*(p+q)-2`
3. Sum all results modulo `MOD` and print.

The file `main.py` includes asserts for the sample values from the problem statement:
`P(3,5)=4`, `P(7,31)=20`, `P(1234,4321)=2780`.
